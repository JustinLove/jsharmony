/*
Copyright 2017 apHarmony

This file is part of jsHarmony.

jsHarmony is free software: you can redistribute it and/or modify
it under the terms of the GNU Lesser General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

jsHarmony is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public License
along with this package.  If not, see <http://www.gnu.org/licenses/>.
*/
<% if(model.sample_data) return; %>

<%  
var lovfield = '';
for(var i=0;i<model.fields.length;i++){ 
  var field = model.fields[i];
  if(field.lov){ 
    if(lovfield != '') throw new Error('Can only have one LOV per Multisel.');
    lovfield = field.name; 
  }
}
if(lovfield == '') throw new Error('Multisel requires one LOV.');
%>

(function(jsh){
  var _ = jsh._;
  var $ = jsh.$;
  var XExt = jsh.XExt;
  var xform = null;
  var xform_post = null;
  var modelid = '<%=model.id%>';

  jsh.App.XForm<%=model.id%>_Init = function(callback){
    xform = jsh.App['xform_'+modelid] = new jsh.XData(modelid);
    xform_post = jsh.App['xform_post_'+modelid] = new jsh.XPost(modelid,'','');
    xform.HasUpdates = function(){ return false; };
    xform.Data = {};
    xform.PlaceholderID = '.xmultisel_'+modelid+'_placeholder';
    xform.TemplateID = '.xmultisel_'+modelid+'_template';

    xform.Select = function(onComplete){
      var execparams = {};

      //Pass parameters from bindings
      if(!jsh.is_add){
        _.each(jsh.XForms[modelid]._bindings,function(binding){
          var bfield = jsh.App.XForm<%=model.id%>.prototype.Fields[binding];
          if((typeof bfield != 'undefined') && (jsh.XExt.HasAccess(bfield.actions,'F'))){
            execparams[binding] = jsh.XForms[modelid][binding]();
          }
        });
      }
      else{
        _.each(jsh.XForms[modelid]._bindings,function(binding){
          var bfield = jsh.App.XForm<%=model.id%>.prototype.Fields[binding];
          if((typeof bfield != 'undefined') && (bfield.lovkey)){
            execparams[binding] = jsh.XForms[modelid][binding]();
          }
        });
      }

      jsh.xLoader.StartLoading(xform);
      var _query = '';
      if(!_.isEmpty(execparams)) _query = '?'+$.param(execparams);
      $.ajax({
        type:"GET",
        url:jsh._BASEURL+'_d/'+xform.q+'/'+_query,
        dataType: 'json',
        success:function(data){
          if((data instanceof Object) && ('_error' in data)){
            if(jsh.DefaultErrorHandler(data['_error'].Number,data['_error'].Message)) { }
            else if(data._error.Number == -9){ jsh.XExt.Alert(data._error.Message); }
            else { jsh.XExt.Alert('Error #'+data._error.Number+': '+data._error.Message); }
          }
          else{
            var ejssource = jsh.$root(xform.TemplateID).html();
            ejssource = ejssource.replace(/<#/g,'<'+'%').replace(/#>/g,'%'+'>')
            var ejsrslt = jsh.ejs.render(ejssource,{
              data:data[xform.q],
              jsh: jsh,
              instance: jsh.getInstance()
            });
            jsh.$root(xform.PlaceholderID).empty();
            jsh.$root(xform.PlaceholderID).append(ejsrslt);
          }
          jsh.xLoader.StopLoading(xform);
          if(onComplete) onComplete();
        }
      });
    };

    callback();
  }

  jsh.App.XForm<%=model.id%>_Save = function(){
    var selected_values = [];
    jsh.$root(xform.PlaceholderID+' input.xselitem').each(function(i,obj){
      if($(obj).is(':checked')){
        selected_values.push($(obj).val());
      }
    });
    var _query = {};
    //Pass parameters from bindings
    _.each(jsh.XForms[modelid]._bindings,function(binding){
      var bfield = jsh.App.XForm<%=model.id%>.prototype.Fields[binding];
      if((typeof bfield != 'undefined') && !(jsh.XExt.HasAccess(bfield.actions,'F'))) return;
      _query[binding] = jsh.XForms[modelid][binding]();
      if(jsh.is_add && (typeof  _query[binding] == 'undefined')){
        _query[binding] = '%%%'+binding+'%%%';
      }
    });
    var rslt = { 
      'method':'post',
      'model':xform.q,
      'query':_query,
      'post':{'<%=lovfield%>':JSON.stringify(selected_values)},
      'onComplete':undefined
    };
    return [rslt];
  }

})(<%-instance%>);

<%-jsh.RenderEJS('jsh_multisel.js.datamodel',ejsparams)%>