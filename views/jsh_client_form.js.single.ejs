/*
Copyright 2017 apHarmony

This file is part of jsHarmony.

jsHarmony is free software: you can redistribute it and/or modify
it under the terms of the GNU Lesser General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

jsHarmony is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public License
along with this package.  If not, see <http://www.gnu.org/licenses/>.
*/

<%
var no_B = true;
_.each(model.fields,function(field){ if(XExt.access(field.actions,'B') && (field.control != 'html') && (field.name) && (field.control != 'subform') && (field.control != 'button')) no_B = false; });
%>

(function(jsh){
  var _ = jsh._;
  var $ = jsh.$;
  var XExt = jsh.XExt;

  jsh.App.XForm<%=model.id%>_Init = function(callback){
    var xform_<%=model.id%> = jsh.App.xform_<%=model.id%> = new jsh.XPost('<%=model.id%>','','');
    xform_<%=model.id%>.Data = new jsh.App.XForm<%=model.id%>();

    <% xejs.eachKey(model.fields,function(field){  if(!field.name) return; %>xform_<%=model.id%>.Data.<%=field['name']%> = jsh.XForms['<%=model.id%>'].<%=field['name']%>();<%}); %>
    xform_<%=model.id%>.GetKeys = function(){
      var rslt = new Object();
      if(!jsh.is_add){
        //Browse / Edit Record
        _.each(jsh.XForms['<%=model.id%>']._bindings,function(binding){
          xform_<%=model.id%>.Data[binding] = jsh.XForms['<%=model.id%>'][binding]();
        });
        <% xejs.eachKey(model.fields,function(field){  if(!field.name) return; %>rslt.<%=field['name']%> = this.Data.<%=field['name']%>;<%}); %>
      }
      else {
        //Add Record
        //Add parameters for breadcrumbs
        <% _.each(model.fields,function(field){ if(!field.name) return; if(XExt.access(field.actions,'C')) { %>rslt.<%=field['name']%> = jsh.LiteralOrCollection('<%=field['name']%>',[jsh._GET,this.Data]);<% } }); %>
        <% _.each(model.fields,function(field){ if(!field.name) return; if(field.lovkey){ %>rslt.<%=field['name']%> = jsh.LiteralOrCollection('<%=field['name']%>',[jsh._GET,this.Data]);<% } }); %>
      }
      return rslt; 
    };
    <%-xejs.iif(no_B,'xform_'+model.id+'.Select = function(onComplete){ if(onComplete) onComplete(); }; //No data to select')%>

    //Pull keys from parent
    //Get recordset

    jsh.$root('.xelem<%=model.id%>').keyup(function(){ if(!$(this).hasClass('editable')) return; xform_<%=model.id%>.Data.OnControlUpdate(this); });
    jsh.$root('.xelem<%=model.id%>.dropdown').change(function(){ if(!$(this).hasClass('editable')) return; xform_<%=model.id%>.Data.OnControlUpdate(this); });
    jsh.$root('.xelem<%=model.id%>.checkbox').change(function(){ if(!$(this).hasClass('editable')) return; xform_<%=model.id%>.Data.OnControlUpdate(this); });

    <% _.each(model.fields,function(field){ if(!('control' in field) || !field.name) return; if((field.control=='date') && (XExt.access(field.actions,'IU'))) {%>
    jsh.$root(".<%=field.name%>.xelem<%=model.id%>").datepicker({ changeMonth: true, changeYear: true, dateFormat: ('<%=(field.controlparams?field.controlparams.dateformat:'')%>'||jsh.DEFAULT_DATEFORMAT), onSelect: function(){ if(jsh.is_add) return; xform_<%=model.id%>.Data.OnControlUpdate(this); } });
    <% } }); %>  
    callback();
  }

  jsh.App.XForm<%=model.id%>_Save = function(){
    var data = jsh.App.xform_<%=model.id%>.Data;
    if(!data.Commit()) return;

    var q;
    if(data._is_new) q = jsh.App.xform_<%=model.id%>.PrepInsert;
    else q = jsh.App.xform_<%=model.id%>.PrepUpdate;
    
    var dbtask = q.call(jsh.App.xform_<%=model.id%>,function(rslt){
      if(data._is_new){
        //Pull keys
        data._is_new = false;
      }
    });
    return [dbtask];
  }
  
  jsh.App.XForm<%=model.id%>_Delete = function(callback){
    var is_new =  jsh.App.xform_<%=model.id%>.Data._is_new;
    
    XExt.Confirm("Are you sure you want to delete this "+(is_new ? 'new ':'')+"<%=model.caption[1]%>?",function(){
      if(!is_new){
        jsh.App.xform_<%=model.id%>.Delete.call(jsh.App.xform_<%=model.id%>,function(rslt){
          callback();
        });
      }
      else callback();
    });
  }

})(<%-instance%>);