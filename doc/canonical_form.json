/*
Copyright 2017 apHarmony

This file is part of jsHarmony.

jsHarmony is free software: you can redistribute it and/or modify
it under the terms of the GNU Lesser General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

jsHarmony is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public License
along with this package.  If not, see <http://www.gnu.org/licenses/>.
*/

// Canonical Example
{
  "layout": "grid", //grid, form, form-m, multisel, exec
  "inherits": "C_CA", //Inherit from another form
  "table": "V_E001L",
  "caption": [ "", "Client", "Clients" ], //Three-item array, first item is ignored
  "caption": [ "Client", "Clients" ], //Two-item array
  "caption": [ "Client Information" ], //One-item array
  "title": 
    //Title string:
    "CLIENT - @c_name - STRD" //Can use dynamic parameters from jshsite.globalparams: @c_name, or <#=data.c_name#> for form data, or <#=bcrumbs.PL_YEAR_TXT#> for breadcrumb SQL data, <#=_GET.TO_ID#> for GET Parameters
    //Title with fields from form data:
    "<#=data.c_name#>"
    //Title with fields from breadcrumb sql:
    "<#=bcrumbs.PL_YEAR_TXT#>"
    //Title with GET parameters:
    "<#=_GET.TO_ID#>"
    //Title with SQL lookup
    { "sql":"select getdate()" } //"nodatalock":["c_id"] (If applicable)
    //Title with separate Add/Edit titles
    {
      "add": "Add Customer",
      "edit": "Edit Customer"
    }
    //Title with separate Add/Edit SQL lookups:
    {
      "add": { "sql":"select getdate()" }, //"nodatalock":["c_id"] (If applicable)
      "edit": { "sql":"select c_name||' Contacts' from c where c_id=@c_id" } //"nodatalock":["c_id"] (If applicable)
    }
    //If the title is not set, the caption will be used.  If the caption is not set, the model ID will be used
    //The topmost form's title will be used in the window title
    //If the title is set to blank on a tabbed form, the current tab's title will be used for the window title
  "menu": "clients",  //Can be set to either the top menu id or submenu id
  "actions": "B", //B,BI,BIU,BD,BID,BIUD
  "roles": { "X_X": "*", "X_B": "B" }, //By default, only SYSADMIN & DEV have access.  Permissions only assigned to "main" site, not "client" site
  "roles": 
    "main":   { "SYSADMIN": "*", "*": "B" },
    "client": { "C*": "B" }
  },
  "using": ["jsHarmonyFactory"], //Namespaces used by this model
  "dev": 1, //Enable for users with the "DEV" role, not for users with the "SYSADMIN" role
  "db": "default", //Optional property - use an alternate database connection
  "popup": [ 1000, 900 ],
  "sort": [ "^E_Name asc", "^c_name" ], //^ = Ascending or v = Descending
  //Alternate Syntax
  "sort": [ {"E_Name": "asc"}, {"c_name": "desc"} ],
  "samplerepeat": 5,
  "rowlimit": 5, //Maximum rows returned per iteration in GridView
  "querystring": { "&action": "edit", "|c_id": "@c_id" }, //QueryString Defaults/Overrides = &Override, |Default
  "breadcrumbs":{
    "parents": ["QC_DBDW","CCL","<a href='PLRNDW?action=edit&PL_ID=<#=bcrumbs.PL_ID#>&tabs=%7B&quot;PLRNDW&quot;%3A&quot;PLRL&quot;%7D'>RND - <#=bcrumbs.PL_YEAR_TXT#> - <#=bcrumbs.PL_TYPE_TXT#></a>"], //Simple Breadcrumbs, array of parents.  Can also use HTML and Dynamic JS
    "title": "Client", //Title Override for Breadcrumbs, can use <#=bcrumbs.PL_YEAR_TXT#> for breadcrumb SQL data
    "sql": "select PL_ID,PL_YEAR_TXT,PL_TYPE_TXT from V_PLL where PL_ID=isnull(@PL_ID,(select PL_ID from PLR where PLR_ID=@PLR_ID))",
    "sql_params":["c_id","t_id"],
    "nodatalock": ["c_id"],
    "add": { /* parents, title, sql, sql_params, nodatalock */ },
    "edit": { /* parents, title, sql, sql_params, nodatalock */ }
    }
  },
  "helpid": "CL",
  "js": "function(){}", //Custom JS to be included client-side.  Concatenated with model.js
  "ejs": "HTML CONTENT", //Custom EJS to be included client-side.  Concatenated with model.ejs
  "css": "CSS CONTENT",  //Custom CSS to be included client-side.  Concatenated with model.css
  "tabpos": "top", //top,bottm
  //"curtab":1, //VIRTUAL PROPERTY, DO NOT OVERWRITE
  //sqlselect, sqldownloadselect, sqlinsertencrypt, sqlupdate, sqldelete, sqlrowcount
  "sqlinsert":"insert into %%%TABLE%%%(%%%FIELDS%%%) values(%%%VALUES%%%);select scope_identity() as CHG_ID;",
  "sqlexec": "exec dbo.PLE_NOTIF @c_id,@MDate", //Used by EXEC.  Be sure to add %%%DATALOCKS%%% if applicable
  "sqltype": "multirecordset", //recordset, multirecordset  Used by EXEC.
  "sqlwhere": "C_STS='ACTIVE'", //Additional filter for grid
  //onload(xmodel,callback) - Returns false to not bubble (Executed once all selects are complete, on every reselect.  Callback pulls execution away from main thread, return false, and reset links on completion,
  //onloadimmediate(xmodel) - Runs immediately once select is complete, instead of when all selects are complete for all subforms
  //oninit(xmodel) (Executed when form is first loaded)
  //oninsert(xmodel,urlkeys,url) (FORM ONLY) Returns false to not bubble - Executed after insert operation is completed
  //onvalidate(xmodel, callback) - Must return callback(true) if validation succeeded and handle errors
  //onupdate (xmodel) FORM ONLY)
  //ondestroy (xmodel)
  //oncommit(xmodel, rowid, callback) (GRID ONLY) - Executes after db Update / Insert / Delete.
  //onloadstate(xmodel, state)
  //onrowbind(xmodel,jobj,datarow) (GRID ONLY)
  //onroute (routetype ('singlepage'), req, res, f, require, jsh, modelid, params) - Server-side reroute to different page if necessary, called before any ent data loaded - TOW
  //    routetypes: singlepage, model, d, d_transaction, csv, report, d_report, d_report_html, d_reportjob
  //    params = { query: {...}, post: {...} }
  "nokey": 1, //No primary key - only browse
  "nodatalock": ["c_id"],
  "unbound": 1, //Disable any AppSrv operations
  "tabs": [
    { "name": "General", "caption": "General Info", "target": "C", "bindings": { "c_id": "c_id" }, "showcode": ["VIEW","EDIT"],
      "roles": { "main": ["*"], "client": ["CX_B","CX_X"] }
    },
    { "name": "General", "__REMOVE__": 1 }
    //showcode - If the value of the column defined in model.tabcode is not one of the values of showcode, hide the tab entirely
    //To hide a tab in an inherited form, use "General": null
    //If no caption is specified, name will be used as the caption
  ],
  "tabcode": "A_TYPE", //The column used as a basis for "showcode" - hiding or showing tabs.  Must be defined as a parameter
  "bindings": {"J_ID":"J_ID"}, //Additional bindings for top-level forms
  "tabpanelstyle": "min-width:900px;",
  "tablestyle": "min-width:700px;",
  "formstyle": "min-width:900px;",
  "inlinepopup": 1, //Used internally by program for popuplov child grid
  "codeval": "J_ID", //Used internally by program for popuplov child grid
  "disableautoload": 1, //Disables autoload in grid on scroll to bottom
  "buttons": [
    { 
      "link": "add:H", 
      "icon": "add", 
      "text": "Add %%%CAPTION%%%", 
      "actions": "I", 
      "bindings": { "n_scope_id": "n_scope_id", "n_scope": "'C'", "c_id":  "n_scope_id", "n_type":  "'C'" }, 
      "style": "", 
      "class": "", 
      "roles": { "client": { "CLIENT": "*", "C_ADMIN": "B" } }, 
      "hide_when_target_inaccessible": true, //If true, Add buttons will not show if "I" permission is not on the target form.  True by default.
      "nl": 1 }, //or just put the link for add
    {"link":"js:jsh.App.C_LOVBAR.Add(this,modelid);", "icon": "add", "text": "Add Customer", "actions": "B" },
    {"link": "savenew:", "icon": "add", "text": "Save and New", "actions": "IU" }
    {"link": "savenew:", "icon": "add", "text": "Save and New", "actions": "IU", "group":"Actions" }
    //"link":"js:XExt.popupReport('I',{ c_id: 97 },{ width:900, height:500 });"
  ],
  "hide_system_buttons" : ["print","export","help","filter","clear","add"], //Current only on Grid
  "rowstyle": "<#=xejs.iif(1==1,'color:red;','color:yellow;')#>", //Used in grid to style rows dynamically
  "rowclass": "<#-xejs.case(datarow['PLE_SEL_NOTIF'],'xgrid_row_highlight',!datarow['PLE_SEL_NOTIF_OK'],'xgrid_row_disabled')#>", //Used in grid to style rows dynamically
    //xejs.iif(condition,true,[false])  [false] result is optional
    //xejs.case(condition1,result1,condition2,result2,[catchall_result])
  "reselectafteredit": "row",    "comment1":"row, or blank",
  "newrowposition": "last",      "comment2":"first or last",
  "commitlevel": "row",          "comment3":"cell, row, page, auto, or none", //auto=(if not editable, "none" - if top-level, "row", if subform "page"
  "validationlevel": "cell",     "comment4":"cell, or row",
  "noresultsmessage":  "No results found %%%FORSEARCHPHRASE%%%",
  "grid_expand_filter": 1,
  "grid_rowcount":  1,
  "grid_require_filter": 1, //Do not initially load results
  "grid_save_before_update": 1,
  "duplicate": {"target": "E_DUPLICATE", "bindings": {"e_id":"e_id", "c_id": "c_id"},"link":"edit:EW&e_id=new_e_id","link_text": "Duplicate Item"},
  "templates": { "grid": ".xgrid_calendar_template" },
  "onecolumn": true, //Add newline (nl) after each form field except the first. (form, form-m)  Automatically align width of captions
  "fields": [
    {
      "name": "e_name",
      "type": "varchar", //bigint, varchar, date, decimal, float, int, datetime, char, smallint, tinyint, file, hash, encascii, time, boolean, binary
      "length": "255",
      "precision": [12,6], //For decimal, default is 10,4 if omitted
      "precision": 53, //For float
      "key": 1, //If key exists, then this is a key field
      "foreignkey": 1, //Field is a foreign key (used to ensure datalocks are correctly applied)
      "lovkey": 1, //Used by Multisel to enable additional foreign key in LOV expression, without being a required parameter
      "virtual": 1, //Field is not bound on I/U, can be B, but will not pull updates or respond to HasUpdates
      "static": "js:XExt.UndefinedBlank(jsh._GET['j_id'])", //Static binding, overwrite existing data from form
      "unbound": 1, //Field is completely unbound, not added to Fields array
      "sqlselect": "@BXBUY_ID", //Override select sql for this field on Grid select
      "sqlupdate": "@BXBUY_ID+5",
      "sqlwhere": "x like @E_Name", //Custom where express for "F" fields in Grid
      "caption": "Employee",
      "caption_ext":  "Employee Name", //Optional longer caption for Filter & Validation
      "captionstyle": "font-size:12px;",
      "captionclass": "classname",
      "hidden": 1, //**Deprecated**, use "control":"hidden"
      "access": "B", //BIUD, or F for foreign key, S for Grid Filter/Search in addition to any B.  html and button controls auto-add "B" rights. **C - crumbparameter deprecated**
      "datalock": { "c_id": "client_c_id" }, //Link DataLock ID to query in _config.datalocks.
      "control": "label", //label,html(value),textbox,textzoom,dropdown,date,textarea,subform,html,hidden,password,file_upload,button,linkbutton,tree,checkbox
      "controlparams": { "dateformat": "mm/dd/y" }, //DatePicker Params - dateformat is parameter to jQuery datepicker control for date display
                       {"sqlparams": {"FILE_SIZE": "d_size",  //file_upload params - File Size
                             "FILE_EXT": "d_ext", //File Extension
                             "FILE_UTSTMP": "d_utstmp", //Upload Timestamp - will be combined with TSTMP sql
                             "FILE_UU": "d_uu", //Upload User - will be combined with CUSER sql
                             "FILE_NAME": "d_filename" //Target file name for download
                           },
                           "image": {
                             "crop": [800,600], //Use either crop or resize
                             "resize": [800,600],
                             "resize": [225,75,{ "upsize": true, "extend":  true }], //upsize = increase size if smaller, extend = increase size to max, center content
                             "format": "jpg", //jpg or png
                           },
                           "thumbnails": {
                             "D_Medium": { //Key = file name
                               "crop": [800,600], //Use either crop or resize
                               "resize": [800,600],
                               "resize": [225,75,{ "upsize": true, "extend":  true }],
                               "format": "jpg", //jpg or png
                             } 
                           },
                           "download_button": "Download Document", //Text for download button
                           "preview_button": "View Image", //Text for preview button - opens within new browser window
                           "upload_button": "Upload New File", //Text for upload button
                           "delete_button": "Delete File", //Text for delete button
                           "data_folder": "D"}, //Folder for files, must be unique per model
                      {"item_context_menu": [ //tree params - Context Menu for an Item
                        { "icon": "add", "text": "Add", "command": "XExt.Alert('add' + context_item);", "actions": "IUD" }
                        ],
                       "expand_all": false, //Show nodes expanded by default
                       "expand_to_selected": true
                      },
                      {"value_true":"ON",   //checkbox params
                       "value_false":"OFF",
                       "value_hidden":""
                      },
                      { //**Deprecated** - moved to field.popuplov
                       "codeval": "j_id", //**Deprecated**
                       "popupstyle": "height:200px;", //**Deprecated**
                       "popup_copy_results": { "c_name": "c_name" }, //**Deprecated**
                       "base_readonly":  1, //**Deprecated**
                       "onpopup" //**Deprecated**
                      },
      "controlstyle": "font-size:12px;",
      "controlclass": "classname",
      "onchange": "console.log(JSON.stringify(obj));console.log(newval);XExt.Alert('test');",//Javascript Event Handler for onchange event
      //onchange(obj,newval,e)
      "password": "E_SSN", // For type=encascii
      "salt": "E_SSNHASH", // For type=hash
      "roles": {"CX_X": ""}, //"" to remove access, * for all access, else BIUD
      "format": "phone", //"phone", or ["date","MM/DD/YY HH:mm"], or ["decimal","2"], or ["decimalext","2"] (Decimal that doesn't round up, only adds zeros, up to 20 decimal places), or "ssn", or ["time":"h:mm A"], or ["time":"HH:mm"]  //Date uses Moment.js
      "validate": [ "Required", "MaxLength:5", "MinLength:5", "IsNumeric", "IsNumeric:true" (Only positive), "IsDecimal", "IsDecimal:3" (3 decimal places), "MaxValue:999", "MinValue:100", "RegEx:'/regex/','be a correct value.'", "IsEmail", "IsDate", "IsSSN" ],
      // File can be , ["Required", "MaxSize:5000000" (bytes), "Extension:['.PDF','.JPEG']"]
      "sample": "John Smith",
      "value": "John Smith",
      "link": "edit:CW", //for grid, "add:", "select"...also added tab syntax: "edit:JW&tabs={\"JW\":\"J_QUICK\"}"
      //LOV sql_params must be defined as fields, and must be in the request QueryString
      "lov": { 
        "sql": "select HP_CODE as codeval,HP_Desc as codetxt from HP where 1=1 %%%TRUNCATE%%% order by HP_Desc", 
        "datalock":{"c_id":"client_c_id"}, 
        "sql_params":["c_id","t_id"],
        "sqlselect": "(select hp_desc from jsharmony.hp where hp.hp_code = h.hp_code)",
        "sqltruncate": "HP_CODE=@HP_CODE", //Limit list to one entry - parameter = field.name
        "always_get_full_lov": 1, //Do not truncate LOV to one value, when field is "B", readonly, or value is set in querystring.
        "db": "default" //Optional property - use an alternate database connection
      }, //codeval = Value, codetxt = Desc    "nodatalock":["c_id"] (If applicable)
      "lov": { "sql": "select fcert_id as codeid,fcert_parent_id as codeparentid,fcert_id as codeval,fcert_name as codetxt,'folder' as codeicon from fcert where c_id=(select c_id from E where e_id=@e_id) order by fcert_parent_id, fcert_name, fcert_id", "sql_params":["e_id"] }, //For Tree Control
      "lov": { "sql2": "select X_ID as codeparent, HP_CODE as codeval,HP_Desc as codetxt from HP order by HP_Desc","parent": "ca_country", "datalock":{"c_id":"client_c_id"} }, //codeparent = Parent Value, codeval = Value, codetxt = Desc
      "lov": { "sqlmp": "select X_ID as codeparent1, Y_ID as codeparent2, HP_CODE as codeval,HP_Desc as codetxt from HP order by HP_Desc","parents": ["ca_country","other"], "datalock":{"c_id":"client_c_id"} }, //codeparent[#] = Parent Value, codeval = Value, codetxt = Desc
      "lov": { "UCOD": "e_sts" },
      "lov": { "UCOD2": "dscope_dctgr", "schema": "jsharmony","blank": 1,"parent": "ca_country" }, //Alternatively, blank can be set to text: "blank":"(None)" otherwise defaults to "Please Select..."
      "lov": { "GCOD": "e_ctgr", "showcode": 1 }, //showcode ignores the codetxt and shows the codeval on the front-end.  Useful for States
      "lov": { "GCOD2": "dscope_dctgr", "schema": "jsharmony","blank": 1,"parent": "ca_country" },
      "eol": 1,
      "popuplov": {  //Enable POPUPLOV, requires target grid
                       "target":  "J",
                       "codeval": "j_id",
                       "popupstyle": "height:200px;",
                       "popup_copy_results": { "c_name": "c_name" },
                       "base_readonly":  1,
                       "onpopup": "console.log('popup');", //(popupmodelid, parentmodelid, fieldid, onComplete)
                       "popupiconstyle": "display:none;",
                      },
      "default": "USA",
      "default": "js:moment().format()",
      "default": { "sql": "select c_name from c where c_id=@c_id", "sql_params": ["c_id"] }, //"nodatalock":["c_id"] (If applicable)
      "readonly": 1,
      "always_editable_on_insert": 1, //Make field editable on insert, even if value is set in querystring, or field is readonly
      //for subform, popuplov
      "target": "E_Name",
      "bindings": { "c_id": "c_id" },
      "cellclass": "", //For Grid / Multisel table
      "cellstyle": "width:300px;"  //For Grid / Multisel table
      "html": "<a href='/<#=data[j]['c_id']#>'><#=data[j]['c_name']#></a>" //**Deprecated**, used "control":"html"
      "serverejs": 1, //Evaluate EJS server-side (for HTML)
      "disable_sort": 1, //Only applies to grid
      "enable_search": 1, //Only applies to grid, enable search if it is a hidden column
      "disable_search": 1, //Only applies to grid, do not display as a filter column
      "disable_search_all": 1, //Only applies to grid, do not query in "Any" filter search
      "sqlsort": "(case when X then 1 else 0 end)", //Only applies to grid
      "sqlsearch": "(case when X then 1 else 0 end)", //Only applies to grid
      "sqlsearchsound": "c_id in (select c_id from SDX where SDX_COL='CN' and SDX_VAL=SOUNDEX(%%%FIELD%%%))",
      "__REMOVE__":1, //Remove Model field in inherited child
      "__AFTER__": "FIELDNAME", "__START__", "__END__", //Position in inherited child
      //SYSTEM: datatype_config, sql_from_db, sql_to_db
    }
  ],
  "dberrors": [
    [ "UNQ_H_H_UNIQUE", "This Help Panel has already been defined." ],
    [ "/UNQ_H_H_[UN]*IQUE/", "This Help Panel has already been defined." ]
    //If error/warning/notice begins with "Application Error - " we will show the error message.
    //If error/warning/notice begins with "Application Warning - " we will show the warning message
    //If error/warning/notice has the format "Execute Form - MESSAGE //C?c_id=1" we will show the message and open the form
  ],
  //Auto-generated
  "_inherits": ["CL_X","CL"] //Array of parent models
  "_basemodel": "CL" //Base parent model
  "_referencedby": ["C","C_CC"], //Forms that link to this form
  "namespace": "jsHarmonyFactory",
}